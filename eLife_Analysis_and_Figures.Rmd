---
title: 'Gender and international diversity improves equity in peer review: R Notebook, August 2018'
author: "Dakota Murray"
output:
  html_document:
    df_print: paged
  html_notebook: default
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
  pdf_document: default
---

This notebook documents the analysis of the dataset on peer review outcomes by eLife. Due to the sensitive nature of the data, it is not all made public. However, a sample dataset with all identifying information such as name and instution has been supplied. If you are using this data, run the first code block, and then skip to the "checkpoint" later in the file, after the data has been anonymized.


## Setup
The first step is to set up the environment. We import all the required pacakges and setup our custom ggplot theme. We also define here a simple function that is used to convert p-balues to a series of astericks, and another function that capitalizes the first letter of a word, used for capitalizing place names. 
```{r, message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(readr)
library(readxl)
library(gridExtra)
library(grid)
library(tidyr)

theme_dakota <- function () { 
    theme_bw(base_size=10, base_family="Times") %+replace% 
        theme(
            strip.background = element_blank(),
            strip.text = element_text(face = "bold"),
            plot.title = element_text(size = 11, face = "bold"),
            axis.text.x = element_text(size = 9, margin = margin(t = 5, b = 5)),
            legend.title = element_blank(),
            legend.position = "bottom"
        )
}

# converts a provided p-value into a representation that is easier to visualize
sig2ast <- function(p) { ifelse(p <= 0.0001, "****", 
                                ifelse(p <= 0.001, "***", 
                                       ifelse(p <= 0.01, "**", 
                                              ifelse(p <= 0.05, "*", 
                                                     ifelse(p < 0.1, ".", "ns")
                                              )
                                       )
                                )
                          )
}

# I copied the below function from a stack overflow question. It should capitalize the first letter of each work in a string
# https://stackoverflow.com/questions/6364783/capitalize-the-first-letter-of-both-words-in-a-two-word-string
simpleCap <- function(x) {
  s <- strsplit(x, " ")[[1]]
  paste(toupper(substring(s, 1,1)), substring(s, 2),
      sep="", collapse=" ")
}
```


## Data import and manipulation
Next we import the data. This version of the dataset was compiled from a seried of excel files provided by elife. Several pre-processing steps are not shown here, but are instead in the other R scipt present in this project. Due to the sensitive nature of this data, it has not been made public. Two datasets are created, one representing some basic characteristics of the people at elife, including all types of people and authors, and another dataset containing metadata and outcomes data for all the manuscripts at elife. For the person-level dataset, we simply compile the unique instances of people appearing in the dataset and place them into a dataframe. The manuscript metadata requires additional work. We perform several manupulations and add new variables in order to make analysis easier throughout the document.

1. Disambiguate country names and add continent categories
2. Convert all cases of null-gender assignment to a value of "UNK", or "Unknown". Typically, NA assignments occur when an author is missing (as is the case for reviewer 4, when there are only three reviewers, or for a last author when the manuscript was rejected during initial submission), or when some error occured during the assignment process (no name was matched during the assignment. 
3. Convert all vairbales relating to gender to be a factor with three levels. 
4. Flag the data if no decision has been made for the initial submission, which tends to be the case when they were submitted close our date cutoff.
5. Flag the data if no decision has been made for the full submission, which usuall occurs when the manuscript is pending decision or revisions during our date cutoff.
6. Flag the data if an appeal has been made at any stage of the review process.
7. Flag the data if it has been encouraged during the initial decision phase.
8. Flag the data if it has been submitted and accepted as a full submission
9. Flag the data if there are potential inconsistencies in how names are present. For example, in some full submissions there is no first author present, but there is a last author present. The assumption is that a first author and last author should always be present, even if they are the same person. 
10. Add variables containing a list of all full submission decisions made on each document
11. Add variables for the time spent for reviewers to deliberate each part of the revision process
12. Identify the stage in which the final decision was made
13. Count the number of reviewers invovled in reviewing the full submission
14. Count the number of male and number of female reviewers
15. Create a categorical variable representing the composition of the reviewer team as being all male, all female, or mixed-gender
16. Create an adjusted composition of the reviewer team, this time excluding the BRE, if they are also listed as a reviewer
17. Count the number of revisions that the manuscript went through
18. Create variables representing country homophily between each type of authorship and any member of the reviewer team 
19. Remove potentially sensitive information, such as individual names, institutions, countries, submission dates, etc. 

```{r message=FALSE}
# Load the main eLife data file
elife <- read_excel("~/Dropbox/eLife/data/elife_datafile.xlsx")


# exclude the article type "Scientific Correspondance"
elife <- elife %>% filter(type.x != "RE")

# Load the country infomration .csv file, which was manually created and available along with this file
country_mapping <- read_csv("~/Dropbox/eLife/data/elife_countries.csv")


# Get a single list of all the peer reviewers, which presently are represented as separate variables on each row. This method
# is ugly and can be improved, but it is simple and works, so I won't bother changing it
reviewer1 <- elife[, c("reviewer1_name", "reviewer1_gender", "reviewer1_institution", "reviewer1_country")]
reviewer1 <- reviewer1[with(reviewer1, !is.na(reviewer1_name)), ]
colnames(reviewer1) <- c("reviewer_name", "reviewer_gender", "reviewer_institution", "reviewer_country")

reviewer2 <- elife[, c("reviewer2_name", "reviewer2_gender", "reviewer2_institution", "reviewer2_country")]
reviewer2 <- reviewer2[with(reviewer2, !is.na(reviewer2_name)), ]
colnames(reviewer2) <- c("reviewer_name", "reviewer_gender", "reviewer_institution", "reviewer_country")

reviewer3 <- elife[, c("reviewer3_name", "reviewer3_gender", "reviewer3_institution", "reviewer3_country")]
reviewer3 <- reviewer2[with(reviewer3, !is.na(reviewer3_name)), ]
colnames(reviewer3) <- c("reviewer_name", "reviewer_gender", "reviewer_institution", "reviewer_country")

reviewer4 <- elife[, c("reviewer4_name", "reviewer4_gender", "reviewer4_institution", "reviewer4_country")]
reviewer4 <- reviewer2[with(reviewer4, !is.na(reviewer4_name)), ]
colnames(reviewer4) <- c("reviewer_name", "reviewer_gender", "reviewer_institution", "reviewer_country")

reviewers <- rbind(reviewer1, reviewer2, reviewer3, reviewer4)

# proportion of reviewers by gender compared to proportions of author by gender
bres <- elife[, c("bre_gender", "bre_name", "bre_country")]
peer_reviewers <- reviewers[, c("reviewer_gender", "reviewer_name", "reviewer_country")]
editors <- elife[, c("se_gender", "se_name", "se_country")]
names(editors) <- c("gender", "name", "country")
names(bres) <- c("gender", "name", "country")
names(peer_reviewers) <- c("gender", "name", "country")

revs <- as.data.frame(rbind(bres, editors, peer_reviewers))
revs$type <- "Gatekeeper"
revs <- revs[!is.na(revs$country), ]

# now we add the authors
ca_authors <- elife[, c("ca_gender", "ca_name", "ca_country")]
names(ca_authors) <- c("gender", "name", "country")
ca_authors$type <- "Corr. Author"

fa_authors <- elife[, c("fa_gender", "fa_name", "fa_country")]
names(fa_authors) <- c("gender", "name", "country")
fa_authors$type <- "First Author"

la_authors <- elife[, c("la_gender", "la_name", "la_country")]
names(la_authors) <- c("gender", "name", "country")
la_authors$type <- "Last Author"

# combine all these variables into a single data frame
people <- as.data.frame(rbind(revs, ca_authors, fa_authors, la_authors))
people <- people[!duplicated(people[, c("name", "country", "type")]), ]
people <- people[!is.na(people$name), ]

# Adjust the levels of the gender factor, limit to "Male/Female/UNK", the matching algorithm will assign naems as "unisex", which we can't do anything with. 
people$gender = with(people, relevel(factor(ifelse(gender %in% c("M", "F"), gender, 
                                                                  ifelse(!is.na(name), "UNK", NA)), levels = c("M", "F", "UNK")), ref = "F"))

# Now lets map the continent values onto this dataframe
people <- people %>%
  mutate(country = tolower(country)) %>%
  left_join(country_mapping, by = c("country" = "Country")) %>%
    mutate(
      country = Mapping,
      continent = Continent
    ) %>%
  select(-Mapping, -Continent, -name, -country)


# Moving on, lets begin to work with the manuscript data. 
elife <- elife %>%
  # This group_by is needed to make the mutate functions work propoerly
  group_by(MSNO) %>%
  # these vairbales need to be converted to lowercase for the next step...
  mutate(
    ca_country = tolower(ca_country),
    la_country = tolower(la_country),
    fa_country = tolower(fa_country),
    bre_country = tolower(bre_country),
    se_country = tolower(se_country),
    reviewer1_country = tolower(reviewer1_country),
    reviewer2_country = tolower(reviewer2_country),
    reviewer3_country = tolower(reviewer3_country),
    reviewer4_country = tolower(reviewer4_country)
  ) %>%
  # This series of left_joins + mutates + selects is ugly, but it seems one of the most straightforward ways of adding the country mapping values for 
  # each of the author and reviewer types. 
  left_join(country_mapping, by = c("ca_country" = "Country")) %>%
  mutate(
    ca_country = Mapping,
    ca_continent = Continent
  ) %>%
  select(-Mapping, -Continent) %>%
  left_join(country_mapping, by = c("la_country" = "Country")) %>%
  mutate(
    la_country = Mapping,
    la_continent = Continent
  ) %>%
  select(-Mapping, -Continent) %>%
  left_join(country_mapping, by = c("fa_country" = "Country")) %>%
  mutate(
    fa_country = Mapping,
    fa_continent = Continent
  ) %>%
  select(-Mapping, -Continent) %>%
  left_join(country_mapping, by = c("se_country" = "Country")) %>%
  mutate(
    se_country = Mapping,
    se_continent = Continent
  ) %>%
  select(-Mapping, -Continent) %>%
  left_join(country_mapping, by = c("bre_country" = "Country")) %>%
  mutate(
    bre_country = Mapping,
    bre_continent = Continent
  ) %>%
  select(-Mapping, -Continent) %>%
  left_join(country_mapping, by = c("reviewer1_country" = "Country")) %>%
  mutate(
    reviewer1_country = Mapping,
    reviewer1_continent = Continent
  ) %>%
  select(-Mapping, -Continent) %>%
  left_join(country_mapping, by = c("reviewer2_country" = "Country")) %>%
  mutate(
    reviewer2_country = Mapping,
    reviewer2_continent = Continent
  ) %>%
  select(-Mapping, -Continent) %>%
  left_join(country_mapping, by = c("reviewer3_country" = "Country")) %>%
  mutate(
    reviewer3_country = Mapping,
    reviewer3_continent = Continent
  ) %>%
  select(-Mapping, -Continent) %>%
  left_join(country_mapping, by = c("reviewer4_country" = "Country")) %>%
  mutate(
    reviewer4_country = Mapping,
    reviewer4_continent = Continent
  ) %>%
  select(-Mapping, -Continent) %>%
  # Now I will turn towards the other variables that we will be working with. 
  mutate(
    # convert NA assignments in gender assignment to a value of "Unknown" as well as setup factor levels
    ca_gender = relevel(factor(ifelse(ca_gender %in% c("M", "F"), ca_gender, ifelse(!is.na(ca_name), "UNK", NA)), levels = c("M", "F", "UNK")), ref = "F"),
    fa_gender = relevel(factor(ifelse(fa_gender %in% c("M", "F"), fa_gender, ifelse(!is.na(fa_name), "UNK", NA)), levels = c("M", "F", "UNK")), ref = "F"),
    la_gender = relevel(factor(ifelse(la_gender %in% c("M", "F"), la_gender, ifelse(!is.na(la_name), "UNK", NA)), levels = c("M", "F", "UNK")), ref = "F"),
    se_gender = relevel(factor(ifelse(se_gender %in% c("M", "F"), se_gender, ifelse(!is.na(se_name), "UNK", NA)), levels = c("M", "F", "UNK")), ref = "F"),
    bre_gender = relevel(factor(ifelse(se_gender %in% c("M", "F"), bre_gender, ifelse(!is.na(bre_name), "UNK", NA)), 
                               levels = c("M", "F", "UNK")), ref = "F"),
    reviewer1_gender = relevel(factor(ifelse(reviewer1_gender %in% c("M", "F"), reviewer1_gender, ifelse(!is.na(reviewer1_name), "UNK", NA)), 
                                      levels = c("M", "F", "UNK")), ref = "F"),
    reviewer2_gender = relevel(factor(ifelse(reviewer2_gender %in% c("M", "F"), reviewer2_gender, ifelse(!is.na(reviewer2_name), "UNK", NA)), 
                                      levels = c("M", "F", "UNK")), ref = "F"),
    reviewer3_gender = relevel(factor(ifelse(reviewer3_gender %in% c("M", "F"), reviewer3_gender, ifelse(!is.na(reviewer3_name), "UNK", NA)), 
                                      levels = c("M", "F", "UNK")), ref = "F"),
    reviewer4_gender = relevel(factor(ifelse(reviewer4_gender %in% c("M", "F"), reviewer4_gender, ifelse(!is.na(reviewer4_name), "UNK", NA)), 
                                      levels = c("M", "F", "UNK")), ref = "F"),
   
    submission_year = as.numeric(format(as.Date(initial_submission_time), "%Y")),
    # Flag the data if there is an initial submission but no decision has been made
    initial_decision_made = !is.na(initial_decision),
    
    # Flag is the manuscript had a full submission
    has_full_submission = !is.na(full_submission_date),
    
    # Flag data if full submission has been submitted, but no decision has been made (ie: still in revision or decision stage)
    full_decision_made = !is.na(full_submission_date) & last(na.omit(c(full_decision, rev1_decision, rev2_decision))) != "Revise",
    
    # Flag the data if it was appealed at any state during its process
    appealed_any_stage = any(c(appeal_state1, appeal_state2, appeal_state3) == 4) & any(!is.na(c(appeal_state1, appeal_state2, appeal_state3))),
    
    # Flag the data if the initial decision of the manuscript was encouraged
    encouraged = initial_decision_made & initial_decision == "Encourage",
    
    # Flag the data if the full submission was eventually accepted
    accepted = full_decision_made & any(c(full_decision, rev1_decision, rev2_decision) == "Accept", na.rm = T),
    
    # Flag whether a final decision of accept or reject has been passed
    final_decision_made = any(c(full_decision, rev1_decision, rev2_decision) %in% c("Accept", "Reject"), na.rm = T),
    
    # Flag data if there are potential inconsistencies with the naming, ie: no last name for a full submittion but there is a first name
    #name_inconsistency = full_decision_made & ((!is.na(la_name) & is.na(elife$fa_name)) | ((is.na(la_name) & !is.na(fa_name)))),
    
    # This is a list of all the full decisions made (first decision or full submission + subsequent revisions)
    full_decisions = list(na.omit(c(full_decision, rev1_decision, rev2_decision))),
    
    # Add variables related to how long it takes to go through the review process
    deltatime_rev1 = as.Date(rev1_decision_date) - as.Date(rev1_submission_date),
    deltatime_rev2 = as.Date(rev2_decision_date) - as.Date(rev2_submission_date),
    
    # Store the final stage of the full-submission process in which the final decision was amde
    final_decision_stage = ifelse(full_decision_made, c("Full", "Rev1", "Rev2")[grep("Accept|Reject", unlist(full_decisions))], "Pending"),
    
    # Calculat the total amount of time spent deliberating revision decisions 
    revision_time = ifelse(final_decision_stage == "Full", NA, 
                           ifelse(final_decision_stage == "Rev1", deltatime_rev1,
                                  deltatime_rev1 + deltatime_rev2)),
      
    # Calculate total amount of time spent deliberating decisions from first full submittion to the final decision
    deltatime_final = ifelse(final_decision_stage == "Full", deltatime_full_submission_decision, 
                             ifelse(final_decision_stage == "Rev1", deltatime_rev1 + deltatime_full_submission_decision, 
                                    deltatime_rev2 + deltatime_rev1 + deltatime_full_submission_decision)),
    
    # just some simple boolean values for whether or not the full submission and decision dates are NA—useful once we scrub dates from analysis
    #!has_full_submission = is.na(full_submission_date),
    full_decision_date_isNA = is.na(full_decision_date),

    
    # Now add variables relating to the composition of the reviewer team
    # Quality of list variables—list of the names, countries, and genders of reviewers
    reviewer_names = list(tolower(na.omit(c(bre_name, reviewer1_name, reviewer2_name, reviewer3_name, reviewer4_name)))),
    reviewer_genders = list(na.omit(c(bre_gender, reviewer1_gender, reviewer2_gender, reviewer3_gender, reviewer4_gender))),
    reviewer_countries = list(tolower(na.omit(c(bre_country, reviewer1_country, reviewer2_country, reviewer3_country, reviewer4_country)))),
    reviewer_continents = list(tolower(na.omit(c(bre_continent, reviewer1_continent, reviewer2_continent, reviewer3_continent, reviewer4_continent)))),
    
    reviewer_names_nobre = list(tolower(na.omit(c(reviewer1_name, reviewer2_name, reviewer3_name, reviewer4_name)))),
    reviewer_genders_nobre = list(na.omit(c(reviewer1_gender, reviewer2_gender, reviewer3_gender, reviewer4_gender))),
    
    # Number of reviewers in the team
    num_reviewers = length(unlist(reviewer_names)),
    num_reviewers_nobre = length(unlist(reviewer_names_nobre)),
    
    # Number of reviewers on the team identified as female
    num_female_reviewers = sum(unlist(reviewer_genders) == 1),
    # NUmber of reviewers on the team identified as male
    num_male_reviewers = sum(unlist(reviewer_genders) == 2),
    
    num_female_reviewers_nobre = sum(unlist(reviewer_genders_nobre) == 1),
    # NUmber of reviewers on the team identified as male
    num_male_reviewers_nobre = sum(unlist(reviewer_genders_nobre) == 2),
    
    # Composition: three variables indicaitng whether all have a gender identified as male, all have a gender identified as female, or there is a mix
    # of at least one male and one female reviewer on the team
    composition = factor(ifelse(is.na(full_submission_date), NA, 
                                ifelse(all(unlist(reviewer_genders) == 2), "All Men", 
                                       ifelse(all(unlist(reviewer_genders) == 1), "All Women", 
                                              ifelse(any(unlist(reviewer_genders) == 1) & any(unlist(reviewer_genders) == 2), "Mixed", 
                                                     "Uncertain"
                                                     )
                                              )
                                       )
                                ) # end first ifelse
                         , levels = c("All Men", "All Women", "Mixed", "Uncertain")), # end factor
    # Number of revisions
    num_revisions = length(unlist(full_decisions)) - 1,
    # The corresponding author is from the same country as at least one reviewer 
    ca_country_homophily = !is.na(ca_country) & tolower(ca_country) %in% unlist(reviewer_countries),
    # The last author is from the same country as at least one reviewer
    la_country_homophily = !is.na(la_country) & tolower(la_country) %in% unlist(reviewer_countries),
    # The first author is from the same country as at least one reviewer
    fa_country_homophily = !is.na(fa_country) & tolower(fa_country) %in% unlist(reviewer_countries),
    
    # The corresponding author is from the same country as at least one reviewer 
    ca_continent_homophily = !is.na(ca_continent) & tolower(ca_continent) %in% unlist(reviewer_continents),
    # The last author is from the same country as at least one reviewer
    la_continent_homophily = !is.na(la_continent) & tolower(la_continent) %in% unlist(reviewer_continents),
    # The first author is from the same country as at least one reviewer
    fa_continent_homophily = !is.na(fa_continent) & tolower(fa_continent) %in% unlist(reviewer_continents),
    
    # The BRE is also listed as a reviewer
    bre_is_reviewer = tolower(bre_name) %in% unlist(reviewer_names_nobre),
    
    ca_bre_country_homophily = bre_country == ca_country,
    
    ca_bre_continent_homophily = bre_continent == ca_continent,
    
    # A short series of variables specifying if the first and last authors are the same, or if the CA is also the first/last author
    ca_is_first = tolower(ca_name) == tolower(fa_name),
    ca_is_last = tolower(ca_name) == tolower(la_name),
    single_authored = tolower(fa_name) == tolower(la_name),
    
    # this just cleans up a poorly named variable earlier in the preprocessing step
    submission_type = type.x,
    
    # Recalculate the composition, but this time justed for the BRE
    num_female_reviewers_adj = ifelse(bre_is_reviewer == T & bre_gender == "F", num_female_reviewers_nobre - 1, num_female_reviewers_nobre),
    num_male_reviewers_adj = ifelse(bre_is_reviewer ==T & bre_gender == "M", num_male_reviewers_nobre - 1, num_male_reviewers_nobre),
    num_reviewers_adj = ifelse(bre_is_reviewer, num_reviewers_nobre - 1, num_reviewers_nobre),
    composition_adj = ifelse(!has_full_submission, NA, 
                             ifelse(num_male_reviewers_adj > 0 & num_female_reviewers_adj > 0, "Mixed",
                                    ifelse(num_male_reviewers_adj == num_reviewers_adj, "All Men", 
                                           ifelse(num_female_reviewers_adj == num_reviewers_adj, "All Women", "Uncertain"
                                                  )
                                       )
                                )
                  )
  ) %>%
  filter(submission_type != "RE")
```




Lets calculate some basic things, before we anonymize the data, like number of unique co-authors, etc.

## Initial Submissions and General Info

### Number of initial submissions
```{r}
dim(elife)[1]
```


### Distribution of manuscript types
```{r}
table(elife$type.x)
```

### Distribution of manuscript types, as %
```{r}
prop.table(table(elife$type.x))
```


### Review outcome of initial submissions to eLife
```{r}
outcomes <- elife %>%
  mutate(outcome = ifelse(!initial_decision_made, "No Decision Yet", ifelse(encouraged, "Encouraged", "Rejected")))

table(outcomes$outcome)
```

## Proportion of initial submissions with decisions which were accepted/rejected
```{r}
with_decision <- outcomes %>% filter(outcome != "No Decision Yet")

prop.table(table(with_decision$outcome))
```


### Gender dsitirbution of distinct corresponding authors of initial submissions to eLife 
```{r}
# get distint corresondign authros on first submissions
ca_authors <- elife %>% 
  mutate(ca_name = tolower(ca_name)) %>%
  group_by(ca_name, ca_country) %>%
  filter(row_number() == 1)

table(ca_authors$ca_gender)
```

### National distribution of distinct corresonding authors of initial submissions
```{r}
t <- table(ca_authors$ca_country)
t[order(-t)]
```

### Gender distibution of distinct senior editors of initial submissions 
```{r}
# get distint corresondign authros on first submissions
se_authors <- elife %>% 
  mutate(se_name = tolower(se_name)) %>%
  group_by(se_name, se_country) %>%
  filter(row_number() == 1)

table(se_authors$se_gender)
```

### National distribution of distinct senior editors of initial submissions
```{r}
t <- table(se_authors$se_country)
t[order(-t)]
```

## Full Submissions

### Total number of full submissions
```{r}
full <- elife %>%
  filter(has_full_submission)

dim(full)[1]
```

###Final decision outcomes for full submissions
```{r}
outcomes <- full %>%
  mutate(outcome = ifelse(!final_decision_made, "No Decision Yet", ifelse(accepted, "Accepted", "Rejected")))

table(outcomes$outcome)
```

### First full decision outcomes for full submissions
```{r}
table(ifelse(is.na(full$full_decision), "No Decision", full$full_decision))
prop.table(table(ifelse(is.na(full$full_decision), "No Decision", full$full_decision)))
```

###First revision review outcomes for full submissions
```{r}
rev1 <- full %>% filter(!is.na(rev1_submission_date))
table(ifelse(is.na(rev1$rev1_decision), "No Decision", rev1$rev1_decision))
```

###Second revision review outcomes for full submissions
```{r}
rev2 <- full %>% filter(!is.na(rev2_submission_date))
table(ifelse(is.na(rev2$rev2_decision), "No Decision", rev2$rev2_decision))
```

###Number of distinct corresponding authors in full submissions at eLife
```{r}
ca_authors <- full %>% 
  filter(!is.na(ca_name)) %>%
  mutate(ca_name = tolower(ca_name)) %>%
  group_by(ca_name, ca_country) %>%
  filter(row_number() == 1)

dim(ca_authors)[1]
```

###Gender distirbution of distinct correpsonding authors on full submissions at eLife
```{r}
table(ca_authors$ca_gender)
```

###Number of distinct first authors on full submissions at eLife
```{r}
fa_authors <- full %>% 
  filter(!is.na(fa_name)) %>%
  mutate(fa_name = tolower(fa_name)) %>%
  group_by(fa_name, fa_country) %>%
  filter(row_number() == 1)

dim(fa_authors)[1]
```

###Gender distirbution of distinct first authors on full submissions at eLife
```{r}
table(fa_authors$fa_gender)
prop.table(table(fa_authors$fa_gender))
```

###Gender distirbution of distinct gender-identified first authors on full submissions at eLife
```{r}
identified <- fa_authors %>% filter(fa_gender %in% c("M", "F"))
table(identified$fa_gender)
prop.table(table(identified$fa_gender))
```

###Number of distinct last authors on full submissions at eLife
```{r}
la_authors <- full %>% 
  filter(!is.na(la_name)) %>%
  mutate(la_name = tolower(la_name)) %>%
  group_by(la_name, la_country) %>%
  filter(row_number() == 1)

dim(la_authors)[1]
```

### Gender distirbution of distinct last authors on full submissions at eLife
```{r}
table(la_authors$la_gender)
```

### Gender distirbution of distinct gender-identified first authors on full submissions at eLife
```{r}
identified <- la_authors %>% filter(la_gender %in% c("M", "F"))
table(identified$la_gender)
prop.table(table(identified$la_gender))
```

### Gender distirbution of distinct last authors on full submissions at eLife, as %
```{r}
prop.table(table(la_authors$la_gender))
```


### Number of distinct gatekeepers involved in processing full submissions at eLife, includes senior editors, reviewing editors, and invited peer reviewers
```{r}
gatekeepers <- people %>% filter(type == "Gatekeeper")
dim(gatekeepers)[1]
```

### Gender distirbution of distinct gatekeepers involved in processing full submissions at eLife, includes senior editors, reviewing editors, and invited peer reviewers
```{r}
table(gatekeepers$gender)
prop.table(table(gatekeepers$gender))
```

###Gender distribution of distinct gatekeepers invovled in the processing of full submissions submissions at eLife, but now for only gender-identified individuals
```{r}
identified <- gatekeepers %>% filter(gender %in% c("M", "F"))
table(identified$gender)
prop.table(table(identified$gender))
```


### Continent distirbution of distinct gatekeepers involved in processing full submissions at eLife, includes senior editors, reviewing editors, and invited peer reviewers
```{r}
table(gatekeepers$continent)
prop.table(table(gatekeepers$continent))
```


###Proportion of full submissions for which the correposnding author was also the first author
```{r}
sum(full$ca_name == full$fa_name, na.rm = T) / dim(full)[1]
```


###Proportion of full submissions for which the correposnding author was also the last author
```{r}
sum(tolower(full$ca_name) == tolower(full$la_name), na.rm = T) / dim(full)[1]
```

###Number of full submissions that were appealed
```{r}
table(full$appealed_any_stage)
```

### Average number of revisions before final acceptance of full submissions at eLife
```{r}
# In this case, "0" means 
f <- full %>% filter(accepted)
mean(f$num_revisions, na.rm = T)
```

###Proportion of full submissions for which the correpsonding auhtor is from the same country as the first author
```{r}
sum(full$ca_country == full$fa_country, na.rm = T) / dim(full)[1]
```


###Proportion of full submissions for which the correpsonding auhtor is from the same country as the last author
```{r}
sum(full$ca_country == full$la_country, na.rm = T) / dim(full)[1]
```


###Number of unique name/role combinations that appear in the data
```{r}
dim(people)[1]
```

###Number of thees combinations for which a gender was assigned
```{r}
sum(people$gender != "UNK")
sum(people$gender != "UNK") / dim(people)[1]

```


###Gender distribution of all name/role combinations that appear in the dataset
```{r}
table(people$gender)
prop.table(table(people$gender))
```


## Table SI.2

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
gatekeepers <- subset(people, type == "Gatekeeper")
editors <- subset(editors, !duplicated(name, country))
reviewers <- subset(reviewers, !duplicated(reviewer_name, reviewer_country))
bres <- subset(bres, !duplicated(name, country))


t1 <- data.frame(table(editors$country), prop.table(table(editors$country)))
t2 <- data.frame(table(reviewers$reviewer_country), prop.table(table(reviewers$reviewer_country)))
t3 <- data.frame(table(bres$country), prop.table(table(bres$country)))

all_data <- t2 %>% 
  left_join(t3, by = "Var1") %>%
  left_join(t1, by = "Var1") %>%
  select(-Var1.1.x, -Var1.1.y, -Var1.1)


names(all_data) <- c("country", "rev.freq", "rev.prop", "bre.freq", "bre.prop", "se.freq", "se.prop")

ord <- with(all_data, order(-se.freq, -bre.freq))

all_data <- all_data[ord, ]

write.csv(all_data, file = "tables/table_SI2.csv")

all_data
```

###Gender distribution of gender-identified correpsonding authors of full submissions
```{r}
identified <- full %>% filter(ca_gender != "UNK")
table(identified$ca_gender)
prop.table(table(identified$ca_gender))
```

###Gender distribution of gender-identified first authors of full submissions
```{r}
identified <- full %>% filter(fa_gender != "UNK")
table(identified$fa_gender)
prop.table(table(identified$fa_gender))
```

###Gender distribution of gender-identified last authors of full submissions
```{r}
identified <- full %>% filter(la_gender != "UNK")
table(identified$la_gender)
prop.table(table(identified$la_gender))
```


## Anonymize and save date
```{r}
# Get rid of these temporary variables
bres <- peer_reviewers <- editors <- revs <- ca_authors <- fa_authors <- la_authors <-  NULL
reviewer1 <- reviewer2 <- reviewer3 <- reviewer4 <- reviewers <- NULL

elife <-elife %>%
  # Now lets remove any identifying information, ie: names and institutions. We also remove country/continent for gatekeepers, as the population is smaller
  # We also remove all dates and times, because thees could probably be used to identify information about a particular manuscript
  # Also, lets remove variables that we will not prefently be working with, just to keep the table clean
  select(-c(ca_name, la_name, fa_name,  se_name, bre_name, reviewer1_name, reviewer2_name, reviewer3_name, reviewer4_name, 
         ca_institution, la_institution, fa_institution, se_institution, bre_institution, 
         reviewer1_institution, reviewer2_institution, reviewer3_institution, reviewer4_institution,
         se_country, bre_country, se_continent, reviewer1_country, reviewer2_country, reviewer3_country, reviewer4_country,
         initial_submission_time, full_submission_date, rev1_submission_date, rev2_submission_date,
         initial_decision_time, full_decision_date, rev1_decision_date, rev2_decision_date, submission_month,
         deltatime_initial_submission_decision,	deltatime_full_submission_decision,	deltatime_initial_submission_to_accept,	deltatime_full_submission_to_accept,
         deltatime_rev1,	deltatime_rev2,	revision_time,	deltatime_final,
         prop_male_reviewers, prop_female_reviewers, appeal_state1, appeal_state2, appeal_state3, type.x, type.y, 
         reviewer_names, reviewer_countries, reviewer_continents, reviewer_genders, full_decisions,
         reviewer_names_nobre, reviewer_genders_nobre))

# write this file as output, so that future analysis can start from this file as a checkpoint
write.csv(elife, "formatted_data/formatted_elife.csv")

write.csv(people, "formatted_data/elife_people.csv")

# clean the namespace
country_mapping <- NULL
```


## Checkpoint
Here we load the data that was manipulated in the previous code chunk. Skip to here if the original (non-anonymized) data is not available.
```{r}
elife <- read.csv("formatted_data/formatted_elife.csv")
```


## Figure 2

Note: Figure 1 wa smade in an external program, *RawGraphics*, and so does not appear in this notebook. 

> Figure 2. Left: Yearly count of initial submissions, encouraged initial submissions, and accepted full submissions to eLife between 2012 and 2016; Right: encourage rate of initial submissions, overall accept rate of initial submissions, and accept rate of full submissions between 2012 and 2016. Submissions during the year of 2017 were not included because we do not have sufficient data for full lifecycle of these manuscripts. 

```{r}
d1 <- elife %>%
  group_by(submission_year) %>%
  summarize(
        paper_count = n(),
        accept_count = sum(accepted == TRUE, na.rm = T),
        encourage_count = sum(encouraged == TRUE, na.rm = T)
  ) %>%
  gather(measure_key, value = measurement, paper_count, encourage_count, accept_count) %>%
  mutate(measure_key = factor(measure_key, levels = c("paper_count", "encourage_count", "accept_count"))) %>%
  filter(submission_year != "2017")
  
  
p1 <- d1 %>%
  ggplot(aes(x = submission_year, y = measurement, linetype = measure_key, color = measure_key, shape = measure_key)) +
  geom_line() +
  geom_point(size = 2) +
  theme_dakota() +
  labs(
    x = "Submission Year",
    y = "Count of Manuscripts"
  ) +
  scale_color_manual(labels = c("accept_count" = "#Accepted", "encourage_count" = "#Encouraged", "paper_count" = "#Submitted"), values = c("black", "blue", "red")) +
  scale_shape_discrete(labels = c("accept_count" = "#Accepted", "encourage_count" = "#Encouraged", "paper_count" = "#Submitted")) +
  scale_linetype_discrete(labels = c("accept_count" = "#Accepted", "encourage_count" = "#Encouraged", "paper_count" = "#Submitted"))
  
  
d2 <- elife %>%
  group_by(submission_year) %>%
  summarize(
        paper_count = n(),
        accept_count = sum(accepted == TRUE, na.rm = T),
        encourage_count = sum(encouraged == TRUE, na.rm = T),
        encourage_rate = encourage_count / paper_count,
        accept_rate = accept_count / paper_count,
        encourage_accept_rate = accept_count / sum(!is.na(full_decision_made) & full_decision_made)
  ) %>%
  gather(measure_key, value = measurement, encourage_rate, accept_rate, encourage_accept_rate) %>%
  mutate(
    measure_key = factor(measure_key, levels = c("encourage_rate", "accept_rate", "encourage_accept_rate"))
  ) %>%
  filter(submission_year < 2017)
  
p2 <- d2 %>%
  ggplot(aes(x = submission_year, y = measurement, linetype = measure_key, color = measure_key, shape = measure_key)) +
  geom_line() +
  geom_point(size = 2) +
  ylim(0, 1) +
  theme_dakota() +
  labs(
    x = "Submission Year",
    y = "Rate"
  ) +
  scale_color_manual(labels = c("accept_rate" = "Overall Accept %", "encourage_rate" = "Encourage %", "encourage_accept_rate" = "Accept %"), 
                     values = c("blue", "red", "purple")) +
  scale_shape_manual(labels = c("accept_rate" = "Overall Accept %", "encourage_rate" = "Encourage %", "encourage_accept_rate" = "Accept %"),
                     values = c(17, 15, 18)) +
  scale_linetype_manual(labels = c("accept_rate" = "Overall Accept %", "encourage_rate" = "Encourage %", "encourage_accept_rate" = "Accept %"), 
                          values = c("dotted", "dashed", "dotdash"))

fig2 <- grid.arrange(p1, p2, ncol = 2)
ggsave("figures/main/fig_2.tiff", plot = fig2, height = 4, width = 7)

write.csv(d1, "formatted_data/figure2_leftpanel_data.csv")
write.csv(d2, "formatted_data/figure2_rightpanel_data.csv")
```


### Data to construct figure 2, right panel, including enocurage, overall accept, and accept rates
```{r}
d2 %>% 
  spread(measure_key, measurement) %>%
  rename(
    overall_accept_rate = accept_rate,
    accept_rate = encourage_accept_rate
    )
```


## Figure 3

>Figure 3. Top: proportion of identified men and women in the populations of distinct gatekeepers (senior editors, reviewing editors, and peer reviewers) and of the populations of distinct corresponding authors, first authors, and last authors; percentages exclude those for whom gender could be identified. Bottom: proportion of people with national affiliations within each of six continents in the population of distinct gatekeepers, and for the population of distinct corresponding, first, and last authors. Black dashed lines overlaid on authorship graphs indicate the proportion of gatekeepers within that gendered or continental category. Asterisks indicate the significance level of X2 tests of independence comparing the frequency of gender or continents between gatekeepers and each authorship type. “\*\*\*\*“ = p < 0.0001; “ns” = p > 0.05.

```{r message=FALSE, warning=FALSE}
# Now lets get the significance levels...
s <- subset(people, type == "Corr. Author" | type == "Gatekeeper" )
t <- t(table(s$gender, s$type))
corr <- chisq.test(t[1, 1:2], p = prop.table(t[2, 1:2]))


s <- subset(people, type == "First Author" | type == "Gatekeeper" )
t <- t(table(s$gender, s$type))
first <- chisq.test(t[1, 1:2], p = prop.table(t[2, 1:2]))


s <- subset(people, type == "Last Author" | type == "Gatekeeper" )
t <- t(table(s$gender, s$type))
last <- chisq.test(t[2, 1:2], p = prop.table(t[1, 1:2]))

sig_df <- data.frame(type = rep(c("Gatekeeper", "Corr. Author", "First Author", "Last Author"), 1), 
                     gender = rep(c("Male", "Female"), 2),  
                     sig = c("N/A", sig2ast(corr$p.value), sig2ast(first$p.value), sig2ast(last$p.value)))

gender_sig_list <- list("Corresponding Author" = corr, "First Author" = first, "Last Author" = last)


expected <- people %>%
  filter(gender %in% c("M", "F")) %>%
  mutate(gender = ifelse(gender == "M", "Male", "Female")) %>%
  filter(type == "Gatekeeper") %>%
  mutate(total = n()) %>%
  group_by(type, gender) %>%
  summarize(
    expected_prop = n() / total[1]
  ) %>%
  ungroup() %>%
  select(-type)


p1 <- people %>%
  filter(gender %in% c("M", "F")) %>%
  mutate(gender = ifelse(gender == "M", "Male", "Female")) %>%
  group_by(type) %>%
  mutate(total = n()) %>%
  group_by(type, gender) %>%
  summarize(
    prop = n() / total[1]
  ) %>%
  ungroup() %>%
  left_join(expected, by = "gender") %>%
  left_join(sig_df, by = c("gender", "type")) %>%
  mutate(
    type = factor(type, levels = c("Gatekeeper", "Corr. Author", "First Author", "Last Author"))
  ) %>%
  # start ggplot
  ggplot(aes(x = gender, y = prop, fill = gender)) +
  geom_bar(stat = "identity", alpha = 0.8, color = "black") +
  geom_bar(stat = "identity", aes(y = expected_prop), alpha = 0, color = "black", fill = "white", size = 0.5, linetype = "dashed") +
  #geom_text(aes(label = paste0(round(prop, 3) * 100, "%"), y = 0.1), size = 3) +
  geom_text(aes(label = sig, x = 1.5, y = 0.9)) +
  geom_segment(aes(x = 1, xend = 2, y = ifelse(sig != "N/A", 0.85, 1.1), yend = ifelse(sig != "N/A", 0.85, 1.1)), color = "black") +
  facet_wrap(~type, nrow = 1) +
  theme_dakota() +
  ylim(c(0, 1)) +
  theme(
    axis.title.x = element_blank(),
    legend.position = "right"
  ) +
  labs(y = "Proportion") +
  guides(fill = F)

s <- subset(people, continent != "Antarctica" & (type == "Corr. Author" | type == "Gatekeeper" ))
t <- t(table(s$continent, s$type))
corr <- chisq.test(t[1, ], p = prop.table(t[2, ]))

s <- subset(people, continent != "Antarctica" & (type == "First Author" | type == "Gatekeeper" ))
t <- t(table(s$continent, s$type))
first <- chisq.test(t[1, ], p = prop.table(t[2, ]))

s <- subset(people, continent != "Antarctica" & (type == "Last Author" | type == "Gatekeeper" ))
t <- t(table(s$continent, s$type))
last <- chisq.test(t[2, ], p = prop.table(t[1, ]))

sig_df <- data.frame(type = rep(c("Gatekeeper", "Corr. Author", "First Author", "Last Author"), 3), 
                     continent = rep(c("Africa", "Asia", "Europe", "North America", "Oceania", "South America"), 2),  
                     sig = c("N/A", sig2ast(corr$p.value), sig2ast(first$p.value), sig2ast(last$p.value)))

continent_sig_list <- list("Corresponding Author" = corr, "First Author" = first, "Last Author" = last)

# Now we should repeat this graph, except this time for the continental representation
expected <- people %>%
  filter(type == "Gatekeeper") %>%
  mutate(total = n()) %>%
  filter(continent != "Antarctica") %>%
  group_by(type, continent) %>%
  summarize(
    expected_prop = n() / total[1]
  ) %>%
  ungroup() %>%
  select(-type)


p2 <- people %>%
  group_by(type) %>%
  mutate(total = n()) %>%
  filter(continent != "Antarctica") %>%
  group_by(type, continent) %>%
  summarize(
    prop = n() / total[1]
  ) %>%
  ungroup() %>%
  left_join(expected, by = "continent") %>%
  left_join(sig_df, by = c("continent", "type")) %>%
  mutate(
    type = factor(type, levels = c("Gatekeeper", "Corr. Author", "First Author", "Last Author")),
    continent = reorder(continent, -prop)
  ) %>%
  # start ggplot
  ggplot(aes(x = continent, y = prop, fill = continent)) +
  geom_bar(stat = "identity", alpha = 0.8, color = "black") +
  geom_bar(stat = "identity", aes(y = expected_prop), alpha = 0, color = "black", fill = "white", size = 0.5, linetype = "dashed") +
  #geom_text(aes(label = paste0(round(prop, 3) * 100, "%"), y = 0.05), size = 2) +
  geom_text(aes(label = sig, x = 3.5, y = 0.92)) +
  geom_segment(aes(x = 1, xend = 6, y = ifelse(sig != "N/A", 0.85, 1.1), yend = ifelse(sig != "N/A", 0.85, 1.1)), color = "black") +
  facet_wrap(~type, nrow = 1) +
  theme_dakota() +
  ylim(c(0, 1)) +
  guides(fill = F) +
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    axis.title.x = element_blank()
  ) +
  labs(y = "Proportion") +
  scale_fill_brewer(palette = "Set2")

fig3 <- grid.arrange(p1, p2)
ggsave("figures/main/fig_3.tiff", plot = fig3, height = 5, width = 7)
```

And below are the explicit results of the significaince tests used in the previous graphs to compare the actual proportion of male/female authors with the expected proportion given the population of gatekeepers. 
```{r}
fig3_top_sig_table <- data.frame(
  authorship = c("Corresponding", "First", "Last"),
  p.value = sapply(gender_sig_list, function(x) x$p.value),
  n = sapply(gender_sig_list, function(x) sum(x$observed)),
  statistic = sapply(gender_sig_list, function(x) x$statistic),
  df = sapply(gender_sig_list, function(x) x$parameter)
)

rownames(fig3_top_sig_table) <- NULL
fig3_top_sig_table
```

And the same for the continent-level tests
```{r}
fig3_bottom_sig_table <- data.frame(
  continent = c("Corresponding", "First", "Last"),
  p.value = sapply(continent_sig_list, function(x) x$p.value),
  n = sapply(continent_sig_list, function(x) sum(x$observed)),
  statistic = sapply(continent_sig_list, function(x) x$statistic),
  df = sapply(continent_sig_list, function(x) x$parameter)
)

rownames(fig3_bottom_sig_table) <- NULL
fig3_bottom_sig_table
```

### Frequencies of author and gatekeeper genders at eLife
```{r rows.print=15}
people %>% 
  group_by(type) %>%
  mutate(total = n()) %>%
  group_by(type, gender) %>%
  summarize(
    freq = n(),
    prop = freq / total[1]
    )
```

### Frequencies of author and gatekepeer continental affilaitions at eLife
```{r rows.print=30}
people %>% 
  group_by(type) %>%
  mutate(total = n()) %>%
  group_by(type, continent) %>%
  summarize(
    freq = n(),
    prop = freq / total[1]
    )
```


## Figure 4

> Figure 4. Percentage of full submissions that were accepted, shown by the gender of the corresponding author, first author, and last author. Authors whose gender is unknown are excluded from analysis. See Figure SI.2 for an extension of this figure including submission rates, encourage rates, and overall acceptance races. Vertical error bars indicate 95th confidence intervals of the proportion of submitted, encouraged, and accepted initial and full submissions. Asterisks indicate significance level of X2 tests of independence of frequency of encourage and acceptance by gender; “\*” = p < 0.05; “ns” = p > 0.05.

Note: There is a lot of extra code with this figure, because this figure originally showed informastion for submission rates and encourage and acceptance rates of initial submissions. Now we only show acceptance rates of full submissions. See figure SI.### for the expanded figure. 

```{r message=FALSE, warning=FALSE}
# First, I'll go through and run all the tests to get signif. values. I toyed around with ways to do this more programatically, but I think that this
# manual method is perhaps the simplest

# First, test the encourage rate diffs
s <- subset(elife, initial_decision_made)
t <- table("ca_gender" = s$ca_gender, "encouraged" = s$encouraged)[1:2,]
ca_encouraged <- chisq.test(t[, 1:2])

# Difference in acceptance rates by gender of corresponding author
s <- subset(elife, initial_decision_made & (!has_full_submission | full_decision_made))
t <- table("ca_gender" = s$ca_gender, "accepted" = s$accepted)[1:2,]
ca_accepted <- chisq.test(t[, 1:2])

# Difference in encourage-acceptance rates by gender of corresponding author
s <- subset(elife, initial_decision_made & full_decision_made)
t <- table("ca_gender" = s$ca_gender, "accepted" = s$accepted)[1:2,]
ca_ea <- chisq.test(t[, 1:2])

# Difference in encourage-acceptance rates by gender of first author
s <- subset(elife, initial_decision_made & full_decision_made)
t <- table("fa_gender" = s$fa_gender, "accepted" = s$accepted)[1:2,]
fa_ea <- chisq.test(t[, 1:2])

# Difference in encourage-acceptance rates by gender of last author
s <- subset(elife, initial_decision_made & full_decision_made)
t <- table("la_gender" = s$la_gender, "accepted" = s$accepted)[1:2,]
la_ea <- chisq.test(t[, 1:2])

# Now we use the results of these tests to construct a table
measurements <- c(rep("submit_rate", 3), rep("encourage_rate", 3), rep("accept_rate", 3), rep("encourage_accept_rate", 3))
author <- rep(c("ca_gender", "fa_gender", "la_gender"), 4)

sig <- c("N/A", "N/A", "N/A", # submit rates, all NA since we don't really compare this
         sig2ast(ca_encouraged$p.value), "N/A", "N/A", # encourage rate
         sig2ast(ca_accepted$p.value), "N/A", "N/A", 
         sig2ast(ca_ea$p.value), sig2ast(fa_ea$p.value), sig2ast(la_ea$p.value)
         )
sig_df <- data.frame(measure_key = factor(measurements), author_key = factor(author), sig = sig)

# Now lets save these test results for later
sig_list <- list("Corresponding author enc. rate" = ca_encouraged, 
                   "Corresponding author acc. rate" = ca_accepted, 
                   "Corresponding author enc-acc rate" = ca_ea, 
                   "First author enc-acc rate" = fa_ea, 
                   "last author enc-acc rate" = la_ea)


data_fig4 <- elife %>%
  filter(initial_decision_made) %>%
  gather(author_key, value = gender, ca_gender, la_gender, fa_gender) %>%
  filter(gender %in% c('M', 'F')) %>%
  group_by(author_key) %>%
  mutate(
    # if not ocnsidering the corr. author, then the count is all full submissions, ie: for when a submission ia made
    total_papers = ifelse(author_key == "ca_gender", n(), sum(has_full_submission))
    )%>%
  group_by(author_key, gender) %>%
  summarize(
        paper_count = n(),
        accept_count = sum(accepted == TRUE, na.rm = T),
        encourage_count = sum(encouraged == TRUE),
        encourage_rate = ifelse(author_key[1] == "ca_gender", encourage_count / n(), NA),
        # this accept rate is the number of accepted papers / number of initial + full submissions
        accept_rate = ifelse(author_key[1] == "ca_gender", accept_count / sum(!has_full_submission | full_decision_made, na.rm = T), NA),
        submit_rate = n() / total_papers[1],
        # this is the number of accepted papers divided by all papers 
        encourage_accept_rate = accept_count / sum(has_full_submission & full_decision_made, na.rm = T)
  ) %>%
  ungroup() %>%
  gather(measure_key, value = measurement, encourage_accept_rate) %>%
  left_join(sig_df, by = c("measure_key", "author_key")) %>%
  mutate(
    author_key = factor(author_key,
                        levels = c("ca_gender", "fa_gender", "la_gender"),
                        labels = c("ca_gender" = "Corresponding Author", "fa_gender" = "First Author", "la_gender" = "Last Author")
                        ),
    measure_key = factor(measure_key, 
                         labels = c("submit_rate" = "Submissions", "encourage_rate" = "Enc %", "accept_rate" = "Overall Acc %", "encourage_accept_rate" = "Accept %"),
                         levels = c("submit_rate", "encourage_rate", "accept_rate", "encourage_accept_rate")),
    gender = ifelse(gender == "F", "Female", "Male"),
    standard_error = 1.96 * sqrt( (measurement * (1 - measurement)) / paper_count),
    lower = measurement - standard_error,
    upper = measurement + standard_error
  )
  
  
fig4 <- data_fig4 %>%
  ggplot(aes(x = gender, y = measurement, color = factor(gender), shape = factor(gender), fill = factor(gender))) +
  geom_bar(stat = "identity", alpha = 0.8, color = "black") +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2, color = "black") +
  geom_text(aes(x = 1.5, y = 0.59, label = ifelse(measure_key == "Submissions", "", as.character(sig))), color = "black") +
  geom_segment(aes(x = 1, xend = 2, y = ifelse(sig != "N/A", 0.58, 1.1), yend = ifelse(sig != "N/A", 0.58, 1.1)), color = "black") +
  #facet_grid(author_key ~ measure_key) +
  facet_wrap(~author_key) +
  coord_cartesian(ylim = c(0.4, 0.6)) +
  theme_dakota() +
  guides(fill = F) +
  labs(
    x = "Gender of Author",
    y = "% of full submissions accepted"
  )

fig4
ggsave("figures/main/fig_4.tiff", plot = fig4, height = 5, width = 7)
```

Signif. test results for figure 4
```{r}
fig4_sig_table <- data.frame(
  test = names(sig_list),
  p.value = sapply(sig_list, function(x) x$p.value),
  n = sapply(sig_list, function(x) sum(x$observed)),
  statistic = sapply(sig_list, function(x) x$statistic),
  df = sapply(sig_list, function(x) x$parameter)
)

rownames(fig4_sig_table)<- NULL
fig4_sig_table
```

### Data used to produce figure 4
```{r rows.print=15}
data_fig4 %>%
  select(-sig, -lower, -upper, -standard_error) %>%
  spread(measure_key, measurement)
```

## Gender distirbution of gender-identified authors on full submissions at eLife, at manuscript level, includes duplicate authors
```{r}
full <- elife %>% 
  filter(has_full_submission)
```

Of correpsonding authors
```{r}
full %>% 
  filter(ca_gender %in% c("M", "F")) %>%
  group_by(ca_gender) %>% 
  summarize(
    freq = n(), 
    prop = freq / dim(full)[1]
  )
```

First authors...
```{r}
full %>% 
  filter(fa_gender %in% c("M", "F")) %>%
  group_by(fa_gender) %>% 
  summarize(
    freq = n(), 
    prop = freq / dim(full)[1]
  )
```

And last authors
```{r}
full %>% 
  filter(la_gender %in% c("M", "F")) %>%
  group_by(la_gender) %>% 
  summarize(
    freq = n(), 
    prop = freq / dim(full)[1]
  )
```


## Figure 5

> Figure 5. Percentage of full submissions that were accepted, shown by the gender of the last author, and divided by the gender composition of the peer reviewers. Text at the base of each bar indicate the number full submissions within each category of reviewer team and authorship gender. Vertical error bars indicate 95th percentile confidence intervals of the proportion of accepted full submissions. For the composition category of “All women reviewers”, error bars extend beyond scale of figure; see Figure SI.3 to see the error interval. Asterisks indicate significance level of X2 tests of independence on frequency of acceptance by gender of author given each team composition; “ns” indicates no observed statistical significance. “\*“ = p < 0.05; “ns” = p > 0.05.

Note: As with figure 4, we ultimately decided to simplify this figure, and so there is some excess code. The expanded code can be found in figure SI.###.

```{r message=FALSE, warning=FALSE}
sig_list <- list()
for(comp in c("All Men", "All Women", "Mixed", "Uncertain")) {
  for(gender_var in c("ca_gender", "fa_gender", "la_gender")) {
    if (!is.na(comp)) {
      sub <- subset(elife, initial_decision_made & full_decision_made & composition == comp)[, c("accepted", gender_var)]
      t <- t(table(sub))[1:2,]
      test = chisq.test(t)
      test$n = dim(sub)[1]
      sig_list[length(sig_list) + 1] <- list(test)
    }
  }
}

sig_df <- data.frame(composition = c(rep("All Men", 3), rep("All Women", 3), rep("Mixed", 3), rep("Uncertain", 3)),
                     author_key = rep(c("ca_gender", "fa_gender", "la_gender"), 4),
                     sig = sapply(sig_list, function(test) { sig2ast(test$p.value)})
)


data_fig5 <- elife %>%
  filter(initial_decision_made & full_decision_made & !is.na(composition)) %>%
  mutate(total_submissions = n()) %>%
  gather(author_key, value = gender, la_gender) %>%
  filter(gender %in% c("M", "F")) %>%
  group_by(composition, author_key, gender) %>%
  summarize(
    paper_count = n(),
    accept_count = sum(accepted == TRUE),
    acceptance_rate = sum(accepted == TRUE) / paper_count,
    standard_error = 1.96 * sqrt( (acceptance_rate * (1 - acceptance_rate)) / paper_count),
    lower = acceptance_rate - standard_error,
    upper = acceptance_rate + standard_error
  ) %>%
  ungroup() %>%
  left_join(sig_df, by = c("composition", "author_key")) %>%
  mutate(
    author_key = factor(author_key,
                        levels = c("ca_gender", "fa_gender", "la_gender"),
                        labels = c("ca_gender" = "Corresponding", "fa_gender" = "First", "la_gender" = "Last"))
    ,
    gender = ifelse(gender == "M", "Male", "Female"),
    composition = factor(composition, labels = c("All Men" = "All-male reviewers", "All Women" = "All-female reviewers", "Mixed" = "Mixed-gender reviewers", "Uncertain" = "Uncertain"))
  ) %>%
  filter(composition != "Uncertain")


fig5 <- data_fig5 %>% 
  ggplot(aes(x = gender, y = acceptance_rate, fill = gender)) +
  geom_bar(stat = "identity", alpha = 0.8, color = "black") +
  geom_text(aes(y = 0.31, label = paper_count), size = 3.5, color = "black") +
  #geom_text(aes(y = 0.1, label = paste0(round(acceptance_rate, 3) * 100, "%")), size = 2.5, color = "black", position = position_dodge(0.87)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2, color = "black", alpha = 0.8) +
  geom_text(aes(x = 1.5, y = 0.76, label = sig), color = "black") +
  #geom_text(aes(x = gender, y = 0.1, label = round(acceptance_rate, 3) * 100 ), color = "black") +
  geom_segment(aes(x = 1.1, xend = 1.9, y = ifelse(sig != "N/A", 0.74, 1.1), yend = ifelse(sig != "N/A", 0.74, 1.1)), color = "black") +
  facet_wrap( ~composition) +
  coord_cartesian(ylim = c(0.30, 0.8)) +
  theme_dakota() +
  guides(fill = F) +
  labs(y = "% of full submissions accepted",
       x = "Gender of Last Author"
  ) 

fig5
ggsave("figures/main/fig_5.tiff", plot = fig5, height = 5, width = 7)
```

###Signif. test resutls for figure 5
```{r}
names(sig_list) <- c("Reviewers all Men - Corresponding", "Reviewers all Men - First", "Reviewers all Men - Last", 
                     "Reviewers all Women - Corresponding", "Reviewers all Women - First", "Reviewers all Women - Last", 
                     "Mixed Gender Reviewers - Corresponding", "Mixed Gender Reviewers - First", "Mixed Gender Reviewers - Last", 
                     "Uncertain Composition - Corresponding", "Uncertain Composition - First", "Uncertain Composition - Last")

fig4_sig_table <- data.frame(
  composition = sapply(strsplit(names(sig_list), " - "), function(x) x[1]),
  authorship = sapply(strsplit(names(sig_list), " - "), function(x) x[2]),
  n = sapply(sig_list, function(x) sum(x$observed)),
  df = sapply(sig_list, function(x) x$parameter),
  statistic = sapply(sig_list, function(x) x$statistic),
  p.value = sapply(sig_list, function(x) x$p.value)
)

rownames(fig4_sig_table) <- NULL
fig4_sig_table
```


###Data used to produce figure 5
```{r}
data_fig5 %>%
  select(-standard_error, -lower, -upper, -sig, -author_key)
```

### Number of full submissions
```{r}
full <- elife %>% filter(has_full_submission)
dim(full)[1]
```


###Number of full submissions for which a final decision of accept or reject was made
```{r}
table(full$final_decision_made)
```

###Reviewer team composition for full submissions with a final decision
```{r}
full_final <- full %>% filter(final_decision_made)
table(full_final$composition)
```

As %
```{r}
prop.table(table(full_final$composition))
```

## Figure 6

> Figure 6. Top: proportion of all initial submissions, encouraged initial submissions, and accepted full submissions comprised by the national affiliation of the corresponding author for the top eight most prolific countries in terms of initial submissions. Bottom: Encourage rate of initial submissions, acceptance rate of initial submissions, and acceptance rate of full submissions by national affiliation of the corresponding author for the top eight more prolific countries in terms of initial submissions. Error bars on bottom panel indicate standard error of proportion of encouraged initial submissions and accepted initial and full submissions for each country. This same graph with the top 16 most prolific nations can be found in Figure SI.4

```{r message=FALSE, warning=FALSE}
# Its easiest and most efficient to calculate these total values outside of the dplyr chain below
total_submissions <- length(unique(elife$MSNO))
total_full_submissions <- sum(!elife$full_decision_date_isNA, na.rm = T)
total_encouraged <- with(elife, sum(initial_decision_made & encouraged, na.rm = T))
total_accepted <- with(elife, sum(full_decision_made & accepted == T, na.rm = T))

# Firs the first plot, this one will show the proportion that each countrie constitutes the total number of submitted, encouraged, and accepted manuscripts
data_fig5_p1 <- elife %>%
  filter(initial_decision_made & (full_decision_made | full_decision_date_isNA) & !is.na(ca_country)) %>%
  mutate(ca_country = factor(sapply(as.character(ca_country), simpleCap))) %>% # capitalize first letter of country stirngs
  group_by(ca_country) %>%
  summarize(
    paper_count = n(),
    accept_count = sum(accepted == TRUE, na.rm = T),
    encourage_count = sum(encouraged == TRUE, na.rm = T),
    full_submissions = sum(has_full_submission),
    prop_of_full =  full_submissions / total_full_submissions,
    prop_of_initial = paper_count / total_submissions,
    prop_of_encouraged = encourage_count / total_encouraged,
    prop_of_accepted = accept_count / total_accepted
  ) %>%
  group_by(ca_country) %>%
  mutate(totals = sum(paper_count)) %>%
  ungroup() %>%
  top_n(8, totals) %>%
  gather(prop_key, value = prop, prop_of_initial, prop_of_full, prop_of_accepted) %>%
  mutate(prop_key = factor(prop_key, 
                           levels = c("prop_of_initial", "prop_of_full", "prop_of_accepted"),
                           labels = c("prop_of_initial" = "Prop. of Initial Submissions", 
                                      "prop_of_full" = "Prop. of Full Submissions", 
                                      "prop_of_accepted" = "Prop. of Accepted Submissions")),
         ca_country = reorder(ca_country, paper_count)
  ) 

p1 <- data_fig5_p1 %>%
  # Start ggplot
  ggplot(aes(x = ca_country, y = prop)) +
  geom_bar(stat = "identity", color = "black", alpha = 0.8, fill = "dodgerblue4", position = position_dodge(1)) +
  geom_text(aes(y = prop, label = paste0(round(prop, 3) * 100, "%")), size = 2.5, hjust = -0.2, family = "Times", position = position_dodge(1)) +
  scale_y_continuous(limits = c(0, 1)) +
  facet_wrap(~prop_key, labeller = labeller(key = labels)) +
  theme_dakota() +
  coord_flip() +
  ylim(0, 0.7) +
  labs(y = "") +
  theme(
    strip.background = element_blank(),
    text = element_text(size = 10, family = "Times"),
    plot.title = element_text(size = 12),
    strip.text = element_text(face = "bold"),
    axis.title.y = element_blank()
  )
  

data_fig5_p2 <- elife %>%
  filter(initial_decision_made & (full_decision_made | full_decision_date_isNA) & !is.na(ca_country)) %>%
  mutate(ca_country = factor(sapply(as.character(ca_country), simpleCap))) %>% # capitalize first letter of country stirngs
  group_by(ca_country) %>%
  summarize(
    paper_count = n(),
    accept_count = sum(accepted == TRUE, na.rm = T),
    encourage_count = sum(encouraged == TRUE, na.rm = T),
    encourage_rate = encourage_count / paper_count,
    accept_rate = accept_count / sum(!has_full_submission | full_decision_made, na.rm = T),
    encourage_accept_rate = accept_count / sum(has_full_submission & full_decision_made, na.rm = T)
  ) %>%
  group_by(ca_country) %>%
  mutate(totals = sum(paper_count)) %>%
  ungroup() %>%
  top_n(8, totals) %>%
  mutate(
    ca_country = reorder(ca_country, encourage_accept_rate)
  ) %>%
  gather(measure_key, value = measurement, encourage_rate, accept_rate, encourage_accept_rate) %>%
  mutate(measure_key = factor(measure_key, 
                           levels = c("encourage_accept_rate", "encourage_rate", "accept_rate"),
                           labels = c("encourage_accept_rate" = "% of full submissions accepted",
                                      "encourage_rate" = "% of initial submissions encouraged", 
                                      "accept_rate" = "% of initial submissions accepted"
                                      ))
  ) %>%
  group_by(measure_key) %>%
  mutate(
    se = 1.96 * sqrt(measurement * (1 - measurement) / paper_count),
    lower = measurement - se,
    upper = measurement + se
  ) 

p2 <- data_fig5_p2 %>%
  ggplot(aes(x = ca_country, y = measurement)) +
  geom_bar(stat = "identity", color = "black", fill = "dodgerblue4", alpha = 0.8) +
  geom_text(aes(y = measurement, label = paste0(round(measurement, 3) * 100, "%")), size = 2.5, hjust = -0.6, family = "Times") +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  facet_wrap(~measure_key, labeller = labeller(key = labels)) +
  theme_dakota() +
  labs(y = "%") +
  coord_flip() +
  ylim(0, 0.7) +
  theme(
    axis.title.y = element_blank()
  )

fig6 <- grid.arrange(p1, p2)
ggsave("figures/main/fig_6.tiff", plot = fig6, height = 6, width = 8)
```

### Data to produce figure 5, the top panel
```{r}
data_table <- data_fig5_p1 %>%
  spread(prop_key, prop)

data_table
```

### Proportion of intiial submissions constituted by top 8 counties
```{r}
sum(data_table$`Prop. of Initial Submissions`)
```

### Proportion of full submissions constituted by top 8 counties
```{r}
sum(data_table$`Prop. of Full Submissions`)
```

### Proportion of accepted submissions constituted by top 8 counties
```{r}
sum(data_table$`Prop. of Accepted Submissions`)
```

###Data used to produce figure 5, bottom panel
```{r rows.print = 24}
data_table <- data_fig5_p2 %>%
  select(-se, -lower, -upper)

data_table
```


## Figure 7

> Figure 7. Left: acceptance rate of full submissions compared between presence and absence of homogeneity between the national affiliation of the corresponding author and of at least one. Difference is shown comparing the results for all submissions (top), for all submissions that do not have corresponding authors from the U.S. (middle), and for all submissions that do not have a corresponding author from the U.S., U.K., or Germany (bottom). Right: acceptance rate of full submissions by national homogeneity, shown by individual countries. Included here are the top eight most prolific countries in terms of number of initial submissions. For both panels: vertical error bars indicate 95th percentile confidence intervals for the proportion of accepted full submissions. Values at the base of each bar indicate the number of observations within that combination of country and homophily variables. Asterisks indicate significance level of X2 tests of independence comparing frequency of accepted full submissions between presence and absence of homophily and within each country. “\*\*\*\*” = p < 0.0001; “\*\*\*” = p < 0.01”; “\*“ = p < 0.05; “.” = p < 0.1; “ns” = p > 0.05.

Note: this figure is constructed in multiple parts

```{r message=FALSE, warning=FALSE}
countries <- c("canada", "china", "france", "germany", "japan", "switzerland", "united kingdom", "united states")
sig_list <- list()
for (country in countries) {
  s <- subset(elife, full_decision_made == T & has_full_submission & ca_country == country)
  t <- table(s$ca_country_homophily, s$accepted)
  test = chisq.test(t[, 1:2])
  sig_list[length(sig_list) + 1] <- list(country = test)
}

sig_df <- data.frame(
  ca_country = countries,
  sig = sapply(sig_list, function(l) {sig2ast(l$p.value) })
)

fig7.A <- elife %>%
  filter(full_decision_made & has_full_submission & ca_country %in% countries) %>%
  group_by(ca_country, ca_country_homophily) %>%
  summarize(
    paper_count = n(),
    accept_count = sum(accepted == TRUE, na.rm = T),
    encourage_accept_rate = accept_count / paper_count,
    se = 1.96 * sqrt( (encourage_accept_rate * (1 - encourage_accept_rate)) / paper_count),
    lower = encourage_accept_rate - se,
    upper = encourage_accept_rate + se,
    upper = ifelse(upper > 1, 1, upper)
  ) %>%
  group_by(ca_country) %>%
  mutate(totals = sum(paper_count)) %>%
  ungroup() %>%
  left_join(sig_df) %>%
  #top_n(16, totals) %>% # 8 countries, 3 authorship types per country, therefore first 24 rows
  mutate(ca_country = factor(sapply(as.character(ca_country), simpleCap))) %>%
  # Start ggplot
  ggplot(aes(x = ca_country_homophily, y = encourage_accept_rate, fill = ca_country_homophily)) +
  geom_bar(stat = "identity", position = position_dodge(), color = "black", alpha = 0.8) +
  geom_errorbar(aes(ymin = lower, ymax = upper), color = "black", width = 0.2) +
  geom_text(aes(label = paper_count, y = 0.1), size = 2.5) +
  geom_text(aes(label = sig, x = 1.5, y = 0.95)) +
  geom_segment(aes(x = 1, xend = 2, y = ifelse(sig != "N/A", 0.85, 1.1), yend = ifelse(sig != "N/A", 0.85, 1.1)), color = "black") +
  facet_wrap(~ca_country, nrow = 2, ncol = 4) +
  ylim(0, 1) +
  theme_dakota() +
  guides(fill = FALSE) +
  scale_fill_brewer(palette = "Oranges", labels = c("No Homogeneity", "Homogeneity")) +
  scale_x_discrete(labels = c("No Homogeneity", "Homogeneity")) +
  labs(
    x = "",
    y = "% of full submissions accepted"
  ) +
  theme(
    axis.text.x = element_text(angle = 20, vjust = 1, hjust = 1)
  )

fig7.A
```

And here are the results from the tests used in the graph above
```{r}
fig7_sig_table <- data.frame(
  country = countries,
  p.value = sapply(sig_list, function(x) x$p.value),
  n = sapply(sig_list, function(x) sum(x$observed)),
  statistic = sapply(sig_list, function(x) x$statistic),
  df = sapply(sig_list, function(x) x$parameter)
)

rownames(fig7_sig_table) <- NULL
fig7_sig_table
```


```{r message=FALSE, warning=FALSE}
# Get the data, all countries included
d1 <- elife %>%
  filter(full_decision_made & has_full_submission)

# exclude United States
d2 <- elife %>%
  filter(full_decision_made & has_full_submission) %>%
  filter(ca_country != "united states")

# Excluding all founding countries: U.S., U.K., and Germany
d3 <- elife %>%
  filter(full_decision_made & has_full_submission) %>%
  filter(!ca_country %in% c("united states", "united kingdom", "germany"))


# we also need to get the statistical test infomration for each
t1 <- chisq.test(table(d1$ca_country_homophily, d1$accepted))
t2 <- chisq.test(table(d2$ca_country_homophily, d2$accepted))
t3 <- chisq.test(table(d3$ca_country_homophily, d3$accepted))
sig_list <- list(t1, t2, t3)

sig_df <- data.frame(
  type = c("all", "no us", "no founder"),
  sig = sapply(sig_list, function(l) {sig2ast(l$p.value) })
) 

d1.summ <- d1 %>%
  group_by(ca_country_homophily) %>%
  summarize(
    paper_count = n(),
    accept_count = sum(accepted == TRUE, na.rm = T),
    encourage_accept_rate = accept_count / paper_count,
    se = 1.96 * sqrt( (encourage_accept_rate * (1 - encourage_accept_rate)) / paper_count),
    lower = encourage_accept_rate - se,
    upper = encourage_accept_rate + se,
    upper = ifelse(upper > 1, 1, upper),
    type = "all"
  )

d2.summ <- d2 %>%
  group_by(ca_country_homophily) %>%
  summarize(
    paper_count = n(),
    accept_count = sum(accepted == TRUE, na.rm = T),
    encourage_accept_rate = accept_count / paper_count,
    se = 1.96 * sqrt( (encourage_accept_rate * (1 - encourage_accept_rate)) / paper_count),
    lower = encourage_accept_rate - se,
    upper = encourage_accept_rate + se,
    upper = ifelse(upper > 1, 1, upper),
    type = "no us"
  )

d3.summ <- d3 %>%
  group_by(ca_country_homophily) %>%
  summarize(
    paper_count = n(),
    accept_count = sum(accepted == TRUE, na.rm = T),
    encourage_accept_rate = accept_count / paper_count,
    se = 1.96 * sqrt( (encourage_accept_rate * (1 - encourage_accept_rate)) / paper_count),
    lower = encourage_accept_rate - se,
    upper = encourage_accept_rate + se,
    upper = ifelse(upper > 1, 1, upper),
    type = "no founder"
  )

fig7.B <- d1.summ %>%
  union(d2.summ) %>%
  union(d3.summ) %>%
  left_join(sig_df, by = "type") %>%
  mutate(type = factor(type, 
                       levels = c("all", "no us", "no founder"),
                       labels = c("All Countries", "Excluding U.S.", "Excluding Founding Nations")
                       )
         ) %>%
  ggplot(aes(x = ca_country_homophily, y = encourage_accept_rate, fill = ca_country_homophily)) +
  geom_bar(stat = "identity", position = position_dodge(), color = "black", alpha = 0.8) +
  geom_errorbar(aes(ymin = lower, ymax = upper), color = "black", width = 0.2) +
  geom_text(aes(label = paper_count, y = 0.35), size = 2.5) +
  geom_text(aes(label = sig, x = 1.5, y = 0.65)) +
  geom_segment(aes(x = 1, xend = 2, y = ifelse(sig != "N/A", 0.6, 1.1), yend = ifelse(sig != "N/A", 0.6, 1.1)), color = "black") +
  facet_wrap(~type, nrow = 3) +
  coord_cartesian(ylim = c(0.3, 0.7)) +
  theme_dakota() +
  guides(fill = FALSE) +
  scale_fill_brewer(palette = "Oranges", labels = c("No Homogeneity", "Homogeneity")) +
  scale_x_discrete(labels = c("No Homogeneity", "Homogeneity")) +
  labs(
    x = "",
    y = "% of full submissions accepted"
  )

fig7 <- grid.arrange(fig7.B, fig7.A, ncol = 2, widths = 1:2)

ggsave("figures/main/fig_7.tiff", plot = fig7, height = 4, width = 7)
```


```{r}
fig7.B_sig_table <- data.frame(
  type  = c("all", "no us", "no founer"),
  p.value = sapply(sig_list, function(x) x$p.value),
  n = sapply(sig_list, function(x) sum(x$observed)),
  statistic = sapply(sig_list, function(x) x$statistic),
  df = sapply(sig_list, function(x) x$parameter)
)

rownames(fig7.B_sig_table) <- NULL
fig7.B_sig_table
```

### Presence of author-reviewer national homogeny by country of correposnding author
```{r rows.print = 20}
full <- elife %>% 
  filter(has_full_submission) %>%
  group_by(ca_country) %>%
  summarize(
    submissions = n(),
    prop_homogeny = sum(ca_country_homophily, na.rm = T) / submissions
  ) %>%
  arrange(-prop_homogeny) %>%
  top_n(20)

full

write.csv(full, file = "tables/table_SI3.csv")
```


# Supp. Materials


## Figure SI.1

> Figure SI.1 Average number of revisions a full submissions undergoes before a final decision of accept or reject is made. In this case, zero revisions occurs when a full submission is accepted or rejected without a request for any revisions. The dataset records at maximum two revisions, though only a small number of manuscripts remain in revision after two submissions (see figure 1). For this figure, we only include manuscripts for which a final decision is made after zero, one, or two revisions. The left panel shows differences in the average number of revisions by the country of the last author. The right shows the average revisions by the gender of the last author. 

```{r}
fig_SI.1.A <- elife %>%
  filter(full_decision_made & has_full_submission & la_country %in% countries) %>%
  group_by(la_country) %>%
  summarize(
    avg_revisions = mean(num_revisions)
  ) %>%
  ggplot(aes(x = reorder(la_country, -avg_revisions), y = avg_revisions)) +
  geom_bar(stat = "identity", fill = "dodgerblue4", alpha = 0.8, color = "black") +
  theme_dakota() +
  labs(x = "Country of last author",
       y = "Average number of revisions",
       title = "Avg. revisions by country") +
  coord_cartesian(ylim = c(0.5, 0.85)) +
  theme(
    plot.title = element_text(size = 12, margin = margin(0, 0, 2, 0)),
    axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1)
        )

fig_SI.1.B <- elife %>%
  filter(full_decision_made & has_full_submission & la_gender %in% c("M", "F")) %>%
  group_by(la_gender) %>%
  summarize(
    avg_revisions = mean(num_revisions)
  ) %>%
  ggplot(aes(x = la_gender, y = avg_revisions, fill = la_gender)) +
  geom_bar(stat = "identity", alpha = 0.8, color = "black") +
  theme_dakota() +
  labs(x = "Gender of last author",
       y = "Average number of revisions", 
       title = "Avg. revisions by gender") +
  guides(fill = FALSE) +
  coord_cartesian(ylim = c(0.5, 0.85)) +
  theme(plot.title = element_text(size = 12, margin = margin(0, 0, 2, 0)))
  
fig_SI.1 <- grid.arrange(fig_SI.1.A, fig_SI.1.B, widths = 2:1)

fig_SI.1
ggsave("figures/supp/fig_SI1.tiff", plot = fig_SI.1, height = 4, width = 7)
```


## Figure SI.2

> Figure SI.2. Proportion of initial submissions, encourage rate, overall accept rate, and accept rate of full submissions by the gender of the corresponding author, first author, and last author. Gender metadata is unavailable for first and last authors of initial submissions that were never submitted as full submissions, therefore these cells remain blank. Authors whose gender is unknown are excluded from analysis. Vertical error bars indicate 95th confidence intervals of the proportion of submitted, encouraged, and accepted initial and full submissions. Asterisks indicate significance level of X2 tests of independence of frequency of encourage and acceptance by gender; “\*” = p < 0.05; “ns” = p > 0.05.

```{r message=FALSE, warning=FALSE}
# First, test the encourage rate diffs
s <- subset(elife, initial_decision_made)
t <- table("ca_gender" = s$ca_gender, "encouraged" = s$encouraged)[1:2,]
ca_encouraged <- chisq.test(t[, 1:2])

# Difference in acceptance rates by gender of corresponding author
s <- subset(elife, initial_decision_made & (!has_full_submission | full_decision_made))
t <- table("ca_gender" = s$ca_gender, "encouraged" = s$accepted)[1:2,]
ca_accepted <- chisq.test(t[, 1:2])

# Difference in encourage-acceptance rates by gender of corresponding author
s <- subset(elife, initial_decision_made & full_decision_made)
t <- table("ca_gender" = s$ca_gender, "accepted" = s$accepted)[1:2,]
ca_ea <- chisq.test(t[, 1:2])

# Difference in encourage-acceptance rates by gender of first author
s <- subset(elife, initial_decision_made & full_decision_made)
t <- table("fa_gender" = s$fa_gender, "accepted" = s$accepted)[1:2,]
fa_ea <- chisq.test(t[, 1:2])

# Difference in encourage-acceptance rates by gender of last author
s <- subset(elife, initial_decision_made & full_decision_made)
t <- table("la_gender" = s$la_gender, "accepted" = s$accepted)[1:2,]
la_ea <- chisq.test(t[, 1:2])

# Now we use the results of these tests to construct a table
measurements <- c(rep("submit_rate", 3), rep("encourage_rate", 3), rep("accept_rate", 3), rep("encourage_accept_rate", 3))
author <- rep(c("ca_gender", "fa_gender", "la_gender"), 4)

sig <- c("N/A", "N/A", "N/A", # submit rates, all NA since we don't really compare this
         sig2ast(ca_encouraged$p.value), "N/A", "N/A", # encourage rate
         sig2ast(ca_accepted$p.value), "N/A", "N/A", 
         sig2ast(ca_ea$p.value), sig2ast(fa_ea$p.value), sig2ast(la_ea$p.value)
         )
sig_df <- data.frame(measure_key = factor(measurements), author_key = factor(author), sig = sig)

# Now lets save these test results for later
sig_list <- list("Corresponding author enc. rate" = ca_encouraged, 
                   "Corresponding author acc. rate" = ca_accepted, 
                   "Corresponding author enc-acc rate" = ca_ea, 
                   "First author enc-acc rate" = fa_ea, 
                   "last author enc-acc rate" = la_ea)


fig_SI.2 <- elife %>%
  filter(initial_decision_made) %>%
  gather(author_key, value = gender, ca_gender, la_gender, fa_gender) %>%
  filter(gender %in% c('M', 'F')) %>%
  group_by(author_key) %>%
  mutate(
    # if not ocnsidering the corr. author, then the count is all full submissions, ie: for when a submission ia made
    total_papers = ifelse(author_key == "ca_gender", n(), sum(has_full_submission))
    )%>%
  group_by(author_key, gender) %>%
  summarize(
        paper_count = n(),
        accept_count = sum(accepted == TRUE, na.rm = T),
        encourage_count = sum(encouraged == TRUE),
        encourage_rate = ifelse(author_key[1] == "ca_gender", encourage_count / n(), NA),
        # this accept rate is the number of accepted papers / number of initial + full submissions
        accept_rate = ifelse(author_key[1] == "ca_gender", accept_count / sum(!has_full_submission | full_decision_made, na.rm = T), NA),
        submit_rate = n() / total_papers[1],
        # this is the number of accepted papers divided by all papers 
        encourage_accept_rate = accept_count / sum(has_full_submission & full_decision_made, na.rm = T)
  ) %>%
  ungroup() %>%
  gather(measure_key, value = measurement, submit_rate, encourage_rate, accept_rate, encourage_accept_rate) %>%
  left_join(sig_df, by = c("measure_key", "author_key")) %>%
  mutate(
    author_key = factor(author_key,
                        levels = c("ca_gender", "fa_gender", "la_gender"),
                        labels = c("ca_gender" = "Corresponding Author", "fa_gender" = "First Author", "la_gender" = "Last Author")
                        ),
    measure_key = factor(measure_key, 
                         labels = c("submit_rate" = "Submissions", "encourage_rate" = "Enc %", "accept_rate" = "Overall Acc %", "encourage_accept_rate" = "Accept %"),
                         levels = c("submit_rate", "encourage_rate", "accept_rate", "encourage_accept_rate")),
    gender = ifelse(gender == "F", "Female", "Male"),
    standard_error = 1.96 * sqrt( (measurement * (1 - measurement)) / paper_count),
    lower = measurement - standard_error,
    upper = measurement + standard_error
  ) %>%
  ggplot(aes(x = gender, y = measurement, color = factor(gender), shape = factor(gender), fill = factor(gender))) +
  geom_bar(stat = "identity", alpha = 0.8, color = "black") +
  #geom_text(aes(y = 0.08, label = paper_count), size = 2.5, color = "black") +
  #geom_text(aes(x = gender, y = 0.1, label = round(measurement, 3) * 100 ), color = "black") +
  #facet_grid(measure_key ~ author_key) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2, color = "black") +
  geom_text(aes(x = 1.5, y = 0.95, label = ifelse(measure_key == "Submissions", "", as.character(sig))), color = "black") +
  geom_segment(aes(x = 1, xend = 2, y = ifelse(sig != "N/A", 0.90, 1.1), yend = ifelse(sig != "N/A", 0.90, 1.1)), color = "black") +
  facet_grid(author_key ~ measure_key) +
  coord_cartesian(ylim = c(0, 1)) +
  theme_dakota() +
  guides(fill = F) +
  labs(
    x = "Gender of Author",
    y = "% accepted of full submissions"
  )

fig_SI.2
ggsave("figures/supp/fig_SI2.tiff", plot = fig_SI.2, height = 4, width = 7)
```


## Figure SI.3

>Figure SI.3. Percentage of full submissions that were accepted, shown by the gender of the corresponding, first, and last author, and by the gender composition of the peer reviewers. Text at the base of each bar indicate the number full submissions within each category of reviewer team and authorship gender. Vertical error bars indicate 95th percentile confidence intervals of the proportion of accepted full submissions. Asterisks indicate significance level of X2 tests of independence on frequency of acceptance by gender of author given each team composition; “ns” indicates no observed statistical significance. “\*“ = p < 0.05; “ns” = p > 0.05.

```{r message=FALSE, warning=FALSE}
sig_list <- list()
for(comp in c("All Men", "All Women", "Mixed", "Uncertain")) {
  for(gender_var in c("ca_gender", "fa_gender", "la_gender")) {
    if (!is.na(comp)) {
      sub <- subset(elife, initial_decision_made & full_decision_made & composition == comp)[, c("accepted", gender_var)]
      t <- t(table(sub))[1:2,]
      test = chisq.test(t)
      test$n = dim(sub)[1]
      sig_list[length(sig_list) + 1] <- list(test)
    }
  }
}

sig_df <- data.frame(composition = c(rep("All Men", 3), rep("All Women", 3), rep("Mixed", 3), rep("Uncertain", 3)),
                     author_key = rep(c("ca_gender", "fa_gender", "la_gender"), 4),
                     sig = sapply(sig_list, function(test) { sig2ast(test$p.value)})
)

fig_SI.3 <- elife %>%
  filter(initial_decision_made & full_decision_made & !is.na(composition)) %>%
  mutate(total_submissions = n()) %>%
  gather(author_key, value = gender, ca_gender, fa_gender, la_gender) %>%
  filter(gender %in% c("M", "F")) %>%
  group_by(composition, author_key, gender) %>%
  summarize(
    paper_count = n(),
    accept_count = sum(accepted == TRUE),
    acceptance_rate = sum(accepted == TRUE) / paper_count,
    standard_error = 1.96 * sqrt( (acceptance_rate * (1 - acceptance_rate)) / paper_count),
    lower = acceptance_rate - standard_error,
    upper = acceptance_rate + standard_error
  ) %>%
  ungroup() %>%
  left_join(sig_df, by = c("composition", "author_key")) %>%
  mutate(
    author_key = factor(author_key,
                        levels = c("ca_gender", "fa_gender", "la_gender"),
                        labels = c("ca_gender" = "Corresponding", "fa_gender" = "First", "la_gender" = "Last"))
    ,
    gender = ifelse(gender == "M", "Male", "Female")
  ) %>%
  # Start ggplot
  ggplot(aes(x = gender, y = acceptance_rate, fill = gender)) +
  geom_bar(stat = "identity", alpha = 0.8, color = "black") +
  geom_text(aes(y = 0.1, label = paper_count), size = 2.5, color = "black") +
  #geom_text(aes(y = 0.1, label = paste0(round(acceptance_rate, 3) * 100, "%")), size = 2.5, color = "black", position = position_dodge(0.87)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2, color = "black", alpha = 0.8) +
  geom_text(aes(x = 1.5, y = 0.90, label = sig), color = "black") +
  #geom_text(aes(x = gender, y = 0.1, label = round(acceptance_rate, 3) * 100 ), color = "black") +
  geom_segment(aes(x = 1, xend = 2, y = ifelse(sig != "N/A", 0.8, 1.1), yend = ifelse(sig != "N/A", 0.8, 1.1)), color = "black") +
  facet_grid(author_key ~ composition) +
  ylim(0, 1) +
  theme_dakota() +
  guides(fill = F) +
  labs(y = "Encourage-Acceptance Rate",
       x = "Gender of Author"
  ) 

fig_SI.3
ggsave("figures/supp/fig_SI2.tiff", plot = fig_SI.2, height = 4, width = 7)
```





## Figure SI.4

>Figure SI.4 Top: proportion of all initial submissions, encouraged initial submissions, and accepted full submissions comprised by the national affiliation of the corresponding author for the top sixteen most prolific countries in terms of initial submissions. Bottom: acceptance rate of full submissions, encourage rate of full submissions, and overall accept rate of full submissions by national affiliation of the corresponding author for the top eight more prolific countries in terms of initial submissions. Error bars on bottom panel indicate standard error of proportion of encouraged initial submissions and accepted initial and full submissions for each country.


```{r message=FALSE, warning=FALSE}
# Its easiest and most efficient to calculate these total values outside of the dplyr chain below
total_submissions <- length(unique(elife$MSNO))
total_full_submissions <- sum(!elife$full_decision_date_isNA, na.rm = T)
total_encouraged <- with(elife, sum(initial_decision_made & encouraged, na.rm = T))
total_accepted <- with(elife, sum(full_decision_made & accepted == T, na.rm = T))

# Firs the first plot, this one will show the proportion that each countrie constitutes the total number of submitted, encouraged, and accepted manuscripts
p1 <- elife %>%
  filter(initial_decision_made & (full_decision_made | full_decision_date_isNA) & !is.na(ca_country)) %>%
  mutate(ca_country = factor(sapply(as.character(ca_country), simpleCap))) %>% # capitalize first letter of country stirngs
  group_by(ca_country) %>%
  summarize(
    paper_count = n(),
    accept_count = sum(accepted == TRUE, na.rm = T),
    encourage_count = sum(encouraged == TRUE, na.rm = T),
    full_submissions = sum(has_full_submission),
    prop_of_full =  full_submissions / total_full_submissions,
    prop_of_initial = paper_count / total_submissions,
    prop_of_encouraged = encourage_count / total_encouraged,
    prop_of_accepted = accept_count / total_accepted
  ) %>%
  group_by(ca_country) %>%
  mutate(totals = sum(paper_count)) %>%
  ungroup() %>%
  top_n(16, totals) %>%
  gather(prop_key, value = prop, prop_of_initial, prop_of_full, prop_of_accepted) %>%
  mutate(prop_key = factor(prop_key, 
                           levels = c("prop_of_initial", "prop_of_full", "prop_of_accepted"),
                           labels = c("prop_of_initial" = "Prop. of Initial Submissions", 
                                      "prop_of_full" = "Prop. of Full Submissions", 
                                      "prop_of_accepted" = "Prop. of Accepted Submissions")),
         ca_country = reorder(ca_country, paper_count)
  ) %>%
  # Start ggplot
  ggplot(aes(x = ca_country, y = prop)) +
  geom_bar(stat = "identity", color = "black", alpha = 0.8, fill = "dodgerblue4", position = position_dodge(1)) +
  geom_text(aes(y = prop, label = paste0(round(prop, 3) * 100, "%")), size = 2.5, hjust = -0.2, family = "Times", position = position_dodge(1)) +
  scale_y_continuous(limits = c(0, 1)) +
  facet_wrap(~prop_key, labeller = labeller(key = labels)) +
  theme_dakota() +
  coord_flip() +
  ylim(0, 0.7) +
  labs(y = "") +
  theme(
    strip.background = element_blank(),
    text = element_text(size = 10, family = "Times"),
    plot.title = element_text(size = 12),
    strip.text = element_text(face = "bold"),
    axis.title.y = element_blank()
  )
  

p2 <- elife %>%
  filter(initial_decision_made & (full_decision_made | full_decision_date_isNA) & !is.na(ca_country)) %>%
  mutate(ca_country = factor(sapply(as.character(ca_country), simpleCap))) %>% # capitalize first letter of country stirngs
  group_by(ca_country) %>%
  summarize(
    paper_count = n(),
    accept_count = sum(accepted == TRUE, na.rm = T),
    encourage_count = sum(encouraged == TRUE, na.rm = T),
    encourage_rate = encourage_count / paper_count,
    accept_rate = accept_count / sum(!has_full_submission | full_decision_made, na.rm = T),
    encourage_accept_rate = accept_count / sum(has_full_submission & full_decision_made, na.rm = T)
  ) %>%
  group_by(ca_country) %>%
  mutate(totals = sum(paper_count)) %>%
  ungroup() %>%
  top_n(16, totals) %>%
  mutate(
    ca_country = reorder(ca_country, encourage_accept_rate)
  ) %>%
  gather(measure_key, value = measurement, encourage_rate, accept_rate, encourage_accept_rate) %>%
  mutate(measure_key = factor(measure_key, 
                           levels = c("encourage_accept_rate", "encourage_rate", "accept_rate"),
                           labels = c("encourage_accept_rate" = "% accepted of full submissions",
                                      "encourage_rate" = "% encouraged of initial submissions", 
                                      "accept_rate" = "%accepted of initial submissions"
                                      ))
  ) %>%
  group_by(measure_key) %>%
  mutate(
    se = 1.96 * sqrt(measurement * (1 - measurement) / paper_count),
    lower = measurement - se,
    upper = measurement + se
  ) %>%
  ggplot(aes(x = ca_country, y = measurement)) +
  geom_bar(stat = "identity", color = "black", fill = "dodgerblue4", alpha = 0.8) +
  geom_text(aes(y = measurement, label = paste0(round(measurement, 3) * 100, "%")), size = 2.5, hjust = -0.4, family = "Times") +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  facet_wrap(~measure_key, labeller = labeller(key = labels)) +
  theme_dakota() +
  labs(y = "%") +
  coord_flip() +
  ylim(0, 0.7) +
  theme(
    axis.title.y = element_blank()
  )

fig_SI.4 <- grid.arrange(p1, p2)
ggsave("figures/supp/fig_SI3.tiff", plot = fig_SI.3, height = 4, width = 7)
```


##Figure SI.5

> Figure SI.5. Proportion of peer reviewer team’s gender compositions by gender of the reviewing editor. Compositions are determined while excluding the reviewing editor from team membership, if they are listed as a peer reviewer. 

```{r}
fig_SI.5 <- elife %>%
  filter(bre_gender %in% c("M", "F")) %>%
  mutate(
    bre_gender = ifelse(bre_gender == "M", "Male Reviewing Editor", "Female Reviewing Editor")
    ) %>%
  group_by(bre_gender) %>%
  mutate(total = n()) %>%
  group_by(composition_adj, bre_gender) %>%
  summarize(
    prop = n() / total[1]
  ) %>%
  ungroup() %>%
  mutate(
    composition_adj = reorder(composition_adj, -prop)
  ) %>%
  #arrange(prop) %>%
  ggplot(aes(x = composition_adj, y = prop, fill = composition_adj)) +
  geom_bar(stat = "identity", color = "black", alpha = 0.8) +
  facet_wrap(~bre_gender) +
  geom_text(aes(label = paste0(round(prop, 3) * 100, "%"), y = prop + 0.025), size = 2.5) +
  theme_dakota() +
  scale_fill_brewer(palette = "Accent") +
  guides(fill = F) +
  ylim(0, 0.7) +
  labs(y = "Proportion",
       x = "Composition of invited peer reviewers"
       )

fig_SI.5
ggsave("figures/supp/fig_SI5.tiff", plot = fig_SI.5, height = 4, width = 7)
```


## Figure SI.6

```{r}
fig_SI.6 <- elife %>%
  filter(has_full_submission & full_decision_made & !is.na(bre_continent)) %>%
  group_by(MSNO) %>%
  mutate(
    num_africa = sum(na.omit(c(reviewer1_continent, reviewer2_continent, reviewer3_continent, reviewer4_continent)) == 1),
    contains_africa = ifelse(bre_is_reviewer & bre_continent == "Africa", num_africa > 1, num_africa > 0),
    num_asia = sum(na.omit(c(reviewer1_continent, reviewer2_continent, reviewer3_continent, reviewer4_continent)) == 2),
    contains_asia = ifelse(bre_is_reviewer & bre_continent == "Asia", num_asia > 1, num_asia > 0),
    num_na = sum(na.omit(c(reviewer1_continent, reviewer2_continent, reviewer3_continent, reviewer4_continent)) == 4),
    contains_na = ifelse(bre_is_reviewer & bre_continent == "North America", num_na > 1, num_na > 0),
    num_eu = sum(na.omit(c(reviewer1_continent, reviewer2_continent, reviewer3_continent, reviewer4_continent)) == 3),
    contains_eu = ifelse(bre_is_reviewer & bre_continent == "Europe", num_eu > 1, num_eu > 0),
    num_sa = sum(na.omit(c(reviewer1_continent, reviewer2_continent, reviewer3_continent, reviewer4_continent)) == 6),
    contains_sa = ifelse(bre_is_reviewer & bre_continent == "South America", num_sa > 1, num_sa > 0),
    num_oceania = sum(na.omit(c(reviewer1_continent, reviewer2_continent, reviewer3_continent, reviewer4_continent)) == 5),
    contains_oceania = ifelse(bre_is_reviewer & bre_continent == "Oceania", num_oceania > 1, num_oceania > 0)
  ) %>%
  group_by(bre_continent) %>%
  mutate(total = n()) %>%
  gather(contains_key, contains, contains_africa, contains_asia, contains_na, contains_eu, contains_sa, contains_oceania) %>%
  group_by(contains_key, contains, bre_continent) %>%
  summarize(
    prop = n() / total[1]
  ) %>%
  ungroup() %>%
  mutate(
    bre_continent = factor(bre_continent, levels = c("North America", "Europe", "Asia", "Oceania", "South America", "Africa")),
    contains_key = factor(contains_key, 
                          levels = c("contains_na", "contains_eu", "contains_asia", "contains_oceania", "contains_sa", "contains_africa"),
                          labels = c("contains_na" = "North America", "contains_eu" = "Europe", 
                                     "contains_asia" = "Asia", "contains_oceania" = "Oceania", 
                                     "contains_sa" = "South America", "contains_africa" = "Africa"))
  ) %>%
  filter(contains == T) %>%
  ggplot(aes(x = contains_key, y = prop, fill = contains_key)) +
  geom_bar(stat = "identity", color = "black", alpha = 0.8) +
  facet_wrap(~bre_continent, ncol = 6) +
  geom_text(aes(label = paste0(round(prop, 3) * 100, "%"), y = prop + 0.025), size = 2) +
  theme_dakota() +
  scale_fill_brewer(palette = "Blues", direction = -1) +
  ylim(0, 1.0) +
   guides(fill = F) +
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)
  ) +
  labs(y = "Proportion",
       x = "Composition of invited peer reviewers"
       )


fig_SI.6
ggsave("figures/supp/fig_SI6.tiff", plot = fig_SI.6, height = 4, width = 7)
```



## Figure SI.7

> Figure SI.7. Proportion of initial submissions with a female corresponding author by the country of the corresponding author. Includes only countries with at least 200 initial submissions to eLife between 2012 and 2017.

```{r}
fig_SI.7 <- elife %>%
  group_by(ca_country) %>%
  mutate(total = n()) %>%
  filter(total > 200) %>%
  filter(ca_gender == "F") %>%
  group_by(ca_country) %>%
  summarize(
    prop = n() / total[1]
  ) %>%
  #group_by(ca_gender) %>%
  mutate(
    ca_country = reorder(ca_country, -prop)
  ) %>%
  ggplot(aes(x = ca_country, y = prop)) +
  geom_bar(stat = "identity", alpha = 0.8, fill = "orange") +
  ylim(0, 0.5) +
  coord_flip() +
  theme_dakota() +
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)
  ) +
  labs(x = "Country of corresponding author",
       y = "Proportion of initial submissions with female correpsonding author") +
  scale_fill_discrete(labels = c("F" = "Female", "M" = "Male"))

fig_SI.7
ggsave("figures/supp/fig_SI7.tiff", plot = fig_SI.7, height = 4, width = 7)
```


### Data used to construct alluvial diagram, figure 1. 
```{r, rows.print = 40}
decisions <- elife %>%
  group_by(elife$initial_decision, elife$full_decision, elife$rev1_decision, elife$rev2_decision) %>%
  summarize(
    freq = n()
  )


decisions

write.csv(decisions, "~/desktop/decisions.csv")
```

